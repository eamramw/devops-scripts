pipeline {
    agent any

    parameters {
        string(name: 'FREE_SPACE_THRESHOLD', defaultValue: '70', description: 'Required free disk space (%)')
        string(name: 'LOG_FILE', defaultValue: '/var/log/syslog', description: 'Log file to scan')
        string(name: 'SEARCH_PATTERN', defaultValue: 'CoreDump', description: 'Pattern to search in log')
    }

    triggers {
        cron('* * * * *') // every minute; adjust as needed
    }

    options {
        timestamps()
        disableConcurrentBuilds()
    }

    stages {
        stage('Checkout Self') {
            steps {
                // This will pull the repo containing both Jenkinsfile & Python scripts
                checkout scm
            }
        }

        stage('Run Disk & Log Check') {
            steps {
                script {
                    def status = sh(
                        script: "python3 scripts/python/check_disk_and_logs.py ${params.FREE_SPACE_THRESHOLD} ${params.LOG_FILE} '${params.SEARCH_PATTERN}'",
                        returnStatus: true
                    )

                    if (status == 1) {
                        error("Disk check failed: Pattern found in logs")
                    } else {
                        echo "Check completed successfully"
                    }
                }
            }
        }
    }

    post {
        success {
            echo "âœ… Build successful"
