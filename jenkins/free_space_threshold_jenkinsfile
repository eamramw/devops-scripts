pipeline {
    agent any

    parameters {
        string(name: 'FREE_SPACE_THRESHOLD', defaultValue: '70', description: 'Required free disk space (%)')
        string(name: 'LOG_FILE', defaultValue: '/var/log/syslog', description: 'Log file to scan')
        string(name: 'SEARCH_PATTERN', defaultValue: 'CoreDump', description: 'Pattern to search in log')
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/eamramw/devops-scripts.git'
            }
        }

        stage('Run Python Script') {
            steps {
                script {
                    def status = sh(
                        script: "python3 check_disk_and_logs.py ${params.FREE_SPACE_THRESHOLD} ${params.LOG_FILE} '${params.SEARCH_PATTERN}'",
                        returnStatus: true
                    )

                    if (status == 1) {
                        error("Disk check failed: Pattern found in logs")
                    } else if (status == 2) {
                        currentBuild.result = 'UNSTABLE'
                        echo "WARNING: Log file missing, marking build as UNSTABLE"
                    } else {
                        echo "Check passed successfully"
                    }
                }
            }
        }
    }
}
